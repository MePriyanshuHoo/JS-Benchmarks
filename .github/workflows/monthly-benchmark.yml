name: Monthly Framework Benchmark (C++)

on:
  schedule:
    # Run on the 1st of every month at 02:00 UTC
    - cron: '0 2 1 * *'
  workflow_dispatch: # Allow manual triggering
    inputs:
      custom_config:
        description: 'Custom benchmark configuration'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      matrix:
        node-version: [20, 22]
      fail-fast: false

    steps:
    - name: ğŸ›’ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“‹ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: ğŸŸ¡ Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: ğŸ”§ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libcurl4-openssl-dev pkg-config
        echo "âœ… System dependencies installed"

    - name: âš¡ Install WRK
      run: |
        echo "Installing WRK load testing tool..."
        git clone https://github.com/wg/wrk.git /tmp/wrk
        cd /tmp/wrk
        make
        sudo cp wrk /usr/local/bin/
        rm -rf /tmp/wrk
        wrk --version || echo "WRK version info"
        echo "âœ… WRK installed successfully"

    - name: ğŸ“¦ Install framework dependencies
      run: |
        npm install
        echo "Node.js frameworks installed"
        bun install --frozen-lockfile
        echo "Bun frameworks installed"

    - name: ğŸ”¨ Build C++ benchmark
      run: |
        echo "Compiling C++ benchmark orchestrator..."
        make clean
        make check-deps
        make release
        echo "âœ… C++ benchmark compiled successfully"
        ls -la bin/

    - name: ğŸ” Verify installations
      run: |
        echo "=== Runtime Versions ==="
        echo "Node.js: $(node --version)"
        echo "Bun: $(bun --version)"
        echo "WRK: $(wrk --version 2>&1 | head -1)"
        echo "GCC: $(gcc --version | head -1)"
        echo ""
        echo "=== Framework Files ==="
        ls -la *_server.js
        echo ""
        echo "=== C++ Binary ==="
        ls -la bin/benchmark_wrk
        file bin/benchmark_wrk

    - name: ğŸ§ª Test server startup
      run: |
        echo "Testing framework server startup..."

        # Test Express
        timeout 10s node express_server.js &
        EXPRESS_PID=$!
        sleep 3
        curl -f http://localhost:3000 && echo "âœ… Express OK" || echo "âŒ Express failed"
        kill $EXPRESS_PID 2>/dev/null || true
        sleep 1

        # Test Fastify
        timeout 10s node fastify_server.js &
        FASTIFY_PID=$!
        sleep 3
        curl -f http://localhost:3001 && echo "âœ… Fastify OK" || echo "âŒ Fastify failed"
        kill $FASTIFY_PID 2>/dev/null || true
        sleep 1

        # Test Hono
        timeout 10s node hono_server.js &
        HONO_PID=$!
        sleep 3
        curl -f http://localhost:3002 && echo "âœ… Hono OK" || echo "âŒ Hono failed"
        kill $HONO_PID 2>/dev/null || true
        sleep 1

        echo "âœ… Server startup tests completed"

    - name: ğŸƒâ€â™‚ï¸ Run C++ WRK benchmark
      id: benchmark
      run: |
        echo "Starting high-performance C++ WRK benchmark..."
        echo "Node.js version: ${{ matrix.node-version }}"

        # Create results directory
        mkdir -p "results/node-${{ matrix.node-version }}"

        # Set environment
        export NODE_ENV=production

        # Run the C++ benchmark orchestrator
        echo "Executing C++ benchmark..."
        ./bin/benchmark_wrk 2>&1 | tee "results/node-${{ matrix.node-version }}/benchmark-output.log"

        # Check if benchmark completed successfully
        if [ -f "benchmark_results_wrk.json" ]; then
          echo "âœ… C++ WRK Benchmark completed successfully"
          cp benchmark_results_wrk.json "results/node-${{ matrix.node-version }}/benchmark_results_wrk.json"
          cp benchmark_results_wrk.csv "results/node-${{ matrix.node-version }}/benchmark_results_wrk.csv"

          echo "benchmark_success=true" >> $GITHUB_OUTPUT

          # Extract top performer from JSON
          TOP_PERFORMER=$(jq -r '.results | sort_by(.requestsPerSecond) | reverse | .[0].environment' benchmark_results_wrk.json)
          TOP_RPS=$(jq -r '.results | sort_by(.requestsPerSecond) | reverse | .[0].requestsPerSecond' benchmark_results_wrk.json)

          echo "top_performer=${TOP_PERFORMER}" >> $GITHUB_OUTPUT
          echo "top_rps=${TOP_RPS}" >> $GITHUB_OUTPUT

          echo "ğŸ“Š Top performer: $TOP_PERFORMER with $TOP_RPS req/sec"

        else
          echo "âŒ C++ benchmark failed - no results file generated"
          echo "benchmark_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: ğŸ“Š Generate performance summary
      if: steps.benchmark.outputs.benchmark_success == 'true'
      run: |
        echo "## ğŸ“Š C++ WRK Benchmark Results (Node.js ${{ matrix.node-version }})" > benchmark-summary.md
        echo "" >> benchmark-summary.md
        echo "**ğŸ† Top Performer:** ${{ steps.benchmark.outputs.top_performer }}" >> benchmark-summary.md
        echo "**ğŸ“ˆ Peak Performance:** $(printf "%.2f" ${{ steps.benchmark.outputs.top_rps }}) req/sec" >> benchmark-summary.md
        echo "**âš¡ Benchmark Tool:** WRK (C++)" >> benchmark-summary.md
        echo "" >> benchmark-summary.md
        echo "**ğŸ“… Test Date:** $(date -u)" >> benchmark-summary.md
        echo "**ğŸ–¥ï¸ Environment:** Ubuntu Latest, Node.js ${{ matrix.node-version }}" >> benchmark-summary.md
        echo "**ğŸ”§ Compiler:** $(gcc --version | head -1)" >> benchmark-summary.md
        echo "" >> benchmark-summary.md

        # Add top 3 performers
        echo "### ğŸ¥‡ Top 3 Performers" >> benchmark-summary.md
        jq -r '.results | sort_by(.requestsPerSecond) | reverse | .[0:3][] | "- **\(.environment)**: \(.requestsPerSecond | . * 100 | round / 100) req/sec"' benchmark_results_wrk.json >> benchmark-summary.md

        echo "" >> benchmark-summary.md
        echo "### ğŸ“ˆ Performance Metrics" >> benchmark-summary.md
        echo "| Framework | Runtime | RPS | Avg Latency | P90 Latency | P99 Latency | Throughput |" >> benchmark-summary.md
        echo "|-----------|---------|-----|-------------|-------------|-------------|------------|" >> benchmark-summary.md
        jq -r '.results | sort_by(.requestsPerSecond) | reverse | .[] | "| \(.framework) | \(.runtime) | \(.requestsPerSecond | . * 100 | round / 100) | \(.avgLatency | . * 100 | round / 100)ms | \(.p90Latency | . * 100 | round / 100)ms | \(.p99Latency | . * 100 | round / 100)ms | \(.throughput / 1024 / 1024 | . * 100 | round / 100)MB/s |"' benchmark_results_wrk.json >> benchmark-summary.md

    - name: ğŸ“ Generate updated README
      if: steps.benchmark.outputs.benchmark_success == 'true' && matrix.node-version == 22
      run: |
        echo "Generating updated README with C++ WRK benchmark results..."

        # Update README with C++ benchmark results
        cat > README_TEMP.md << 'EOF'
# Framework Benchmark (C++ WRK Implementation)

High-performance benchmarking suite using C++ and WRK for comprehensive performance analysis of Express, Fastify, and Hono across Node.js and Bun runtimes.

## ğŸš€ Latest Benchmark Results

EOF

        cat benchmark-summary.md >> README_TEMP.md

        cat >> README_TEMP.md << 'EOF'

## ğŸ”§ C++ Implementation

This benchmark suite is implemented in C++ for maximum performance and accuracy:

- **WRK Integration**: Uses the industry-standard WRK load testing tool
- **High Performance**: C++ orchestrator with minimal overhead
- **Detailed Metrics**: Comprehensive latency percentiles and throughput analysis
- **Cross-Runtime**: Tests both Node.js and Bun runtime environments

## ğŸƒâ€â™‚ï¸ Running Benchmarks

### Prerequisites

```bash
# Install dependencies
make install-deps

# Verify setup
make check-deps
```

### Build and Run

```bash
# Build the C++ benchmark
make

# Run the benchmark
make run

# Or use npm scripts
npm run benchmark
```

### Results

Benchmark results are saved to:
- `benchmark_results_wrk.json` - Detailed JSON results
- `benchmark_results_wrk.csv` - CSV format for analysis

## ğŸ“Š Framework Servers

The benchmark tests these framework configurations:

- **Express** on Node.js and Bun
- **Fastify** on Node.js and Bun
- **Hono** on Node.js and Bun

Each server implements a simple JSON API endpoint for consistent testing.

## ğŸ” Benchmark Configuration

- **Connections**: 100 concurrent connections
- **Threads**: 12 worker threads
- **Duration**: 30 seconds per test
- **Runs**: 3 runs per configuration (averaged)
- **Warmup**: 3 seconds server startup time
- **Cooldown**: 2 seconds between tests

## ğŸ“ˆ Metrics Collected

- **Requests per Second (RPS)**
- **Average Latency**
- **Latency Percentiles** (P50, P75, P90, P99)
- **Throughput** (MB/s)
- **Error Rates**
- **Timeout Counts**

EOF

        mv README_TEMP.md README.md
        echo "âœ… README generated successfully"

    - name: ğŸ—ƒï¸ Archive historical data
      if: steps.benchmark.outputs.benchmark_success == 'true' && matrix.node-version == 22
      run: |
        mkdir -p data/historical/$(date +%Y)

        TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
        cp benchmark_results_wrk.json "data/historical/$(date +%Y)/wrk_benchmark_${TIMESTAMP}.json"
        cp benchmark_results_wrk.csv "data/historical/$(date +%Y)/wrk_benchmark_${TIMESTAMP}.csv"

        echo "# Monthly C++ WRK Benchmark - $(date +%B_%Y)" > "data/historical/$(date +%Y)/summary_$(date +%Y-%m).md"
        cat benchmark-summary.md >> "data/historical/$(date +%Y)/summary_$(date +%Y-%m).md"

        echo "ğŸ“ Historical C++ benchmark data archived"

    - name: ğŸ” Validate results
      if: steps.benchmark.outputs.benchmark_success == 'true' && matrix.node-version == 22
      run: |
        echo "Validating C++ benchmark results..."

        # Validate JSON structure
        if jq empty benchmark_results_wrk.json; then
          echo "âœ… JSON results are valid"
        else
          echo "âŒ JSON validation failed"
          exit 1
        fi

        # Check CSV format
        if [ -f "benchmark_results_wrk.csv" ] && [ $(wc -l < benchmark_results_wrk.csv) -gt 1 ]; then
          echo "âœ… CSV results are valid"
        else
          echo "âŒ CSV validation failed"
          exit 1
        fi

        # Verify README structure
        if grep -q "C++ WRK Implementation" README.md; then
          echo "âœ… README structure validated"
        else
          echo "âŒ README validation failed"
          exit 1
        fi

    - name: ğŸ“¤ Commit and push changes
      if: steps.benchmark.outputs.benchmark_success == 'true' && matrix.node-version == 22
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "C++ Benchmark Bot"

        git add README.md
        git add benchmark_results_wrk.json
        git add benchmark_results_wrk.csv
        git add data/historical/ || true
        git add results/ || true

        if git diff --staged --quiet; then
          echo "ğŸ“‹ No changes to commit"
        else
          COMMIT_MSG="ğŸš€ Monthly C++ WRK benchmark update - $(date +%B_%Y)

ğŸ“Š Benchmark Results:
- Tool: WRK (C++ Implementation)
- Top Performer: ${{ steps.benchmark.outputs.top_performer }}
- Peak Performance: $(printf "%.2f" ${{ steps.benchmark.outputs.top_rps }}) req/sec
- Node.js Version: ${{ matrix.node-version }}
- Test Date: $(date -u)

ğŸ”§ Technical Details:
- Compiler: $(gcc --version | head -1)
- WRK Version: $(wrk --version 2>&1 | head -1)
- Benchmark Duration: 30s per test, 3 runs averaged

ğŸ”„ Auto-generated by C++ GitHub Actions workflow"

          git commit -m "$COMMIT_MSG"
          git push
          echo "âœ… C++ benchmark results committed and pushed"
        fi

    - name: ğŸ“‹ Upload benchmark artifacts
      if: steps.benchmark.outputs.benchmark_success == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: cpp-wrk-benchmark-node${{ matrix.node-version }}
        path: |
          benchmark_results_wrk.json
          benchmark_results_wrk.csv
          benchmark-summary.md
          results/
          bin/benchmark_wrk
        retention-days: 90

  summary:
    runs-on: ubuntu-latest
    needs: benchmark
    if: always()

    steps:
    - name: ğŸ“Š C++ Benchmark Summary
      run: |
        echo "## ğŸ¯ Monthly C++ WRK Benchmark Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ“… Execution Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ”„ Workflow:** C++ WRK Framework Benchmark" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ“‹ Status:** ${{ needs.benchmark.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**âš¡ Implementation:** High-performance C++ with WRK" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.benchmark.result }}" == "success" ]; then
          echo "âœ… **Result:** C++ benchmark completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ˆ **Deliverables:**" >> $GITHUB_STEP_SUMMARY
          echo "- High-performance C++ binary executed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- WRK load testing completed across all frameworks" >> $GITHUB_STEP_SUMMARY
          echo "- README.md updated with comprehensive results" >> $GITHUB_STEP_SUMMARY
          echo "- JSON and CSV results archived" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Result:** C++ benchmark workflow failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”§ **Debug Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "- Verify C++ compilation with 'make clean && make'" >> $GITHUB_STEP_SUMMARY
          echo "- Check WRK installation with 'wrk --version'" >> $GITHUB_STEP_SUMMARY
          echo "- Test framework servers manually" >> $GITHUB_STEP_SUMMARY
          echo "- Review build dependencies (gcc, libcurl, etc.)" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸš¨ Create failure issue
      if: needs.benchmark.result == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš¨ C++ WRK Benchmark Workflow Failed',
            body: `## ğŸš¨ C++ WRK Benchmark Failure

The automated C++ WRK benchmark workflow has failed.

**ğŸ“… Failure Date:** ${new Date().toISOString()}
**ğŸ”— Workflow Run:** https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

### ğŸ” Failure Analysis

This workflow uses a high-performance C++ implementation with WRK for benchmarking. Common failure points:

1. **C++ Compilation Issues**
   - Missing build dependencies (gcc, libcurl-dev)
   - Compilation errors in benchmark_wrk.cpp

2. **WRK Installation Problems**
   - WRK build/installation failure
   - Missing system dependencies

3. **Framework Server Issues**
   - Server startup failures
   - Port binding conflicts
   - Runtime environment problems

### ğŸ› ï¸ Debug Commands

\`\`\`bash
# Check build environment
make check-deps

# Compile C++ benchmark
make clean && make

# Test WRK installation
wrk --version

# Test individual servers
node express_server.js &
curl http://localhost:3000

# Run C++ benchmark manually
./bin/benchmark_wrk
\`\`\`

### ğŸ“‹ System Requirements

- GCC 7+ with C++17 support
- libcurl development headers
- WRK load testing tool
- Node.js and Bun runtimes

This issue was auto-generated by the C++ benchmark workflow.`,
            labels: ['bug', 'benchmark', 'cpp', 'automation']
          });
